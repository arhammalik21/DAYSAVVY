<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

  <title>DaySavvy</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">


  <!-- Bootstrap CSS and Google Font -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">

  <style>
    /* Base typography and theme-aware colors */
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      background: var(--bs-body-bg);
      color: var(--bs-body-color);
      margin: 0;
    }
    h1, h2 { font-family: 'Montserrat', Arial, sans-serif; }

    /* Page container width and spacing */
    .container { max-width: 900px; margin: 0 auto; }

    /* Flash messages styling */
    .flash { padding: 8px; border-radius: 4px; margin-bottom: 10px; }
    .flash-success { background: #d4edda; color: #155724; }
    .flash-info    { background: #cce5ff; color: #004085; }
    .flash-warning { background: #fff3cd; color: #856404; }

    /* Cards spacing and completed task style */
    .card { margin-bottom: 12px; }
    .completed-task { text-decoration: line-through; color: gray; }

    /* Force dark mode background if theme is dark */
    :root[data-bs-theme='dark'] { --bs-body-bg: #121212; }

    /* Navbar cleanup */
    .navbar { background-color: transparent !important; border-bottom: 0 !important; }

    /* Theme toggle button visuals */
    #themeToggle:hover { filter: brightness(1.15); }
    #themeToggle, #themeToggle:focus, #themeToggle:hover, #themeToggle:active {
      border: none !important; box-shadow: none !important;
    }

    /* Logo/title styles preserved from original */
    .logo-title-container {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 0 !important;
      margin: 20px 0 !important;
      padding: 10 !important;
    }

    .logo {
      width: 200px !important;
      height: 200px !important;
      margin: 0 -40px 0 0 !important;
      padding: 10 !important;
      display: block !important;
    }

    .text-section {
      display: flex !important;
      flex-direction: column !important;
      justify-content: center !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .title {
      font-size: 3.5rem !important;
      font-weight: bold !important;
      color: #4a90e2 !important;
      margin: 0 !important;
      padding: 0 !important;
      letter-spacing: 2px !important;
      line-height: 1 !important;
    }

    .tagline {
      font-size: 1.3rem !important;
      color: #8b5fbf !important;
      margin: 8px 0 0 0 !important;
      padding: 0 !important;
      font-weight: 500 !important;
    }

    /* Buttons and mic visuals kept */
    .btn-ai-mic {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        font-weight: bold;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-ai-mic:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4); background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
    .btn-ai-mic:active { transform: translateY(-1px); }
    .btn-ai-mic i { font-size: 20px; }
    .mic-text { font-size: 14px; letter-spacing: 0.5px; }

    .btn-ai-mic.listening {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
    }

    #stopBtn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 50px;
        font-weight: bold;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    #stopBtn:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        background: linear-gradient(135deg, #ee5a24 0%, #ff6b6b 100%);
    }
    #stopBtn i { font-size: 18px; }

  </style>
</head>

<body>

<!--LOGO WITH TITLE AND TAGLINE -->
<div class="logo-title-container">
  <img src="{{ url_for('static', filename='Logo.png') }}" alt="Logo" class="logo">
  <div class="text-section">
    <h1 class="title">DaySavvy</h1>
    <p class="tagline">A SuperAI that can save your day</p> 
  </div>
</div>

  <!-- Minimal navbar with theme toggle -->
  <nav class="navbar px-3 mb-2 bg-transparent">
    <div class="container-fluid d-flex align-items-center">
      <button id="themeToggle"
              class="p-0 border-0 bg-transparent ms-auto"
              title="Toggle dark mode" aria-label="Toggle dark mode"
              style="font-size:1.35rem; line-height:1;">
        <span id="themeIcon">☀️</span>
      </button>
    </div>
  </nav>

  <!-- Main content container -->
  <div class="container pb-4">

    <!-- Flash messages (feedback after actions) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, message in messages %}
            <div class="flash flash-{{category}}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Field validation (server-side) -->
    {% if form.task.errors %}
      <div class="flash flash-warning">
        {% for error in form.task.errors %}
          {{ error }}
        {% endfor %}
      </div>
    {% endif %}

    <!-- Search & Filter bar -->
    <div class="card mb-3">
      <div class="card-body">
        <form method="GET" action="{{ url_for('index') }}" class="d-flex align-items-center gap-2 flex-wrap">
          <input
            type="text"
            name="q"
            class="form-control flex-grow-1"
            placeholder="Search tasks…"
            value="{{ request.args.get('q','') }}"
            style="min-width:240px;"
          >
          <select name="status" class="form-select" style="width:180px;">
            <option value="" {% if request.args.get('status','') == '' %}selected{% endif %}>All</option>
            <option value="incomplete" {% if request.args.get('status')=='incomplete' %}selected{% endif %}>Incomplete</option>
            <option value="completed"  {% if request.args.get('status')=='completed'  %}selected{% endif %}>Completed</option>
            <option value="overdue"    {% if request.args.get('status')=='overdue'    %}selected{% endif %}>Overdue</option>
          </select>
          <button type="submit" class="btn btn-outline-secondary">Filter</button>
          <!-- Clear resets filters by navigating to / without params -->
          <a class="btn btn-link ms-1" href="{{ url_for('index') }}">Clear</a>
        </form>
      </div>
    </div>

    <!-- Add Task form -->
    <div class="card mb-4">
      <div class="card-header">Add Task</div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('index') }}" class="row g-2">
          {{ form.csrf_token }}
          <div class="col-md-6">
            {{ form.task(class="form-control", placeholder="Task name") }}
          </div>
          <div class="col-md-3">
            {{ form.due_date(class="form-control", placeholder="YYYY-MM-DD") }}
          </div>
          <div class="mb-3">
        <label for="task_time" class="form-label">Time:</label>
        <input type="time" name="task_time" id="task_time" class="form-control">
    </div>
          <div class="col-md-2">
            {{ form.category(class="form-select") }}
          </div>
          <div class="col-md-1 d-grid">
            <button type="submit" class="btn btn-primary">Add</button>
          </div>
        </form>
      </div>
    </div>

<!-- AI voice command block -->
<div class="mb-3">
    <button id="voiceBtn" class="btn btn-ai-mic" onclick="startVoiceControl()" aria-label="Start voice">
        <i class="material-icons-outlined">mic</i>
        <span class="mic-text">AI Voice</span>
    </button>
    <button id="stopBtn" class="btn btn-danger ms-2" onclick="stopVoiceControl()" style="display: none;" aria-label="Stop voice">
        <i class="material-icons-outlined">stop</i>
        Stop
    </button>
    <div id="voiceStatus" class="mt-2 text-muted">Click Start Voice to begin</div>
</div>

<!-- Voice Command -->
<script>
let isListening = false;
let recognition = null;
let csrfToken = null;


// Load CSRF token once
fetch("/csrf-token")
  .then(res => res.json())
  .then(data => {
      csrfToken = data.csrf_token;
      console.log("CSRF loaded:", csrfToken);
  });

// Speak text using Web Speech API
function speakText(text, callback=null) {
    if (!('speechSynthesis' in window)) {
        if (callback) callback();
        return;
    }
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    utter.rate = 1;   
    utter.pitch = 1;  
    utter.onend = () => {
        if (callback) callback();
    };
    window.speechSynthesis.cancel(); // prevent overlapping voices
    window.speechSynthesis.speak(utter);
}

// Start voice control
function startVoiceControl() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        document.getElementById('voiceStatus').textContent = '❌ Speech not supported. Use Chrome.';
        return;
    }

    if (!csrfToken) {
        document.getElementById('voiceStatus').textContent = '⚠️ CSRF token not ready. Retrying...';
        setTimeout(startVoiceControl, 1000);
        return;
    }

    if (isListening) return;
    isListening = true;
    document.getElementById('voiceBtn').classList.add('listening');
    document.getElementById('stopBtn').style.display = 'inline-block';

    listenOnce(); 
}

// Stop voice control
function stopVoiceControl() {
    isListening = false;
    if (recognition) recognition.stop();
    document.getElementById('voiceBtn').classList.remove('listening');
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('voiceStatus').textContent = '🛑 Voice stopped';
}

// Listen for a single phrase
function listenOnce() {
    if (!isListening) return;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false; // only capture final result
    recognition.lang = 'en-US';

    recognition.onstart = () => {
        document.getElementById('voiceStatus').textContent = '🎤 Listening...';
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        document.getElementById('voiceStatus').textContent = `⏳ Processing: "${transcript}"`;

        recognition.stop();

        // Send transcript to backend        
        fetch("/voice/command", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({ transcript })
        })
        .then(res => res.json())
        .then(data => {
            console.log("Backend response:", data);

            speakText(data.message || "I didn’t catch that.", () => {
                document.getElementById('voiceStatus').textContent = `✅ ${data.message}`;

                // Refresh tasks when backend confirms
                if (data.task_added && typeof refreshTaskList === "function") {
                    refreshTaskList();
                }

                // Continue conversation if backend says so
                if (data.continue_listening && isListening) {
                    setTimeout(() => listenOnce(), 600);
                } else {
                    stopVoiceControl();
                }
            });
        })
        .catch(err => {
            console.error("Fetch error:", err);
            document.getElementById('voiceStatus').textContent = "❌ Error sending command";
            stopVoiceControl();
        });
    };

    recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        document.getElementById('voiceStatus').textContent = "❌ Voice error: " + event.error;

        if (event.error === "no-speech" && isListening) {
            setTimeout(() => listenOnce(), 600); // retry softly
        } else {
            stopVoiceControl();
        }
    };

    recognition.onend = () => {
        // Do nothing — we explicitly restart inside .onresult when needed
    };

    recognition.start();
}

// STOP listening button
function stopVoiceControl() {
    if (recognition) recognition.stop();
    isListening = false;
    document.getElementById('voiceBtn').classList.remove('listening');
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('voiceStatus').textContent = "🛑 Voice stopped";
}

// Stop voice control
function stopVoiceControl() {
    if (!isListening) return;
    isListening = false;
    if (recognition) recognition.stop();
    document.getElementById('voiceBtn').classList.remove('listening');
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('voiceStatus').textContent = 'Voice control stopped.';
}


        // FIXED fetch URL
        fetch("/voice/command", {
    method: "POST",
    headers: {
        "Content-Type": "application/json"
    },
    body: JSON.stringify({ transcript })
})

        .then(r => r.json())
        .then(data => {
            console.log("Server response:", data); 
            document.getElementById('voiceStatus').textContent = data.message || 'No message';

            if ('speechSynthesis' in window && data.message) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(data.message);
                utterance.rate = 1.2;

                utterance.onend = () => {
                    if (data.reload_page) {
                        setTimeout(() => location.reload(), 500);
                    } else if (data.continue_listening === false) {
                        stopVoiceControl();
                    } else {
                        setTimeout(() => { if (isListening) startListening(); }, 200);
                    }
                };
                speechSynthesis.speak(utterance);
            } else {
                if (data.continue_listening === false) stopVoiceControl();
                else setTimeout(() => { if (isListening) startListening(); }, 200);
                if (data.reload_page) setTimeout(() => location.reload(), 500);
            }
        })
        .catch(error => {
            console.error('Command error:', error);
            setTimeout(() => { if (isListening) startListening(); }, 500);
        });

    recognition.onend = () => {
        if (isListening && !speechSynthesis.speaking) {
            setTimeout(startListening, 100);
        }
    };

    recognition.onerror = (event) => {
        if (event.error !== 'no-speech') console.error('Recognition error:', event.error);
        if (isListening) setTimeout(startListening, 300);
    };

    try {
      recognition.start();
    } catch (err) {
      console.warn('recognition.start error', err);
    }

function stopVoiceControl() {
    isListening = false;
    if (recognition) try { recognition.stop(); } catch(e){}
    if ('speechSynthesis' in window) speechSynthesis.cancel();

    document.getElementById('voiceBtn').classList.remove('listening');
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('voiceStatus').textContent = 'Voice control stopped';
}

document.addEventListener('DOMContentLoaded', () => {
  const stopBtn = document.getElementById('stopBtn');
  if (stopBtn) stopBtn.addEventListener('click', stopVoiceControl);
});
</script>

<!-- Add Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

<!-- Small extra voice helper removed (duplicate) -->

<form method="post">
    {{ form.hidden_tag() }}
</form>

    <!-- Tasks header with hint about current filter state -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Tasks</h5>
      {% if request.args.get('q') or request.args.get('status') %}
        <small class="text-muted">
          Showing filtered results
          {% if request.args.get('q') %} for "{{ request.args.get('q') }}" {% endif %}
          {% if request.args.get('status') %} ({{ request.args.get('status') }}) {% endif %}
        </small>
      {% else %}
        <small class="text-muted">Showing all tasks</small>
      {% endif %}
    </div>

    <!-- Group tasks into incomplete and completed ON THE FILTERED LIST -->
{% set incomplete_tasks = tasks | selectattr('completed', 'equalto', False) | list %}
{% set completed_tasks  = tasks | selectattr('completed', 'equalto', True)  | list %}

    
<!-- SIMPLE DEBUG  -->
<div class="alert alert-info">
    <h4>Debug Info</h4>
    <p>Incomplete tasks: {{ incomplete_tasks|length }}</p>
    <p>Completed tasks: {{ completed_tasks|length }}</p>
    
    {% if incomplete_tasks %}
        <h5>Incomplete Tasks:</h5>
        <ul>
        {% for task in incomplete_tasks %}
            <li>{{ task.name }} - {{ task.category }} 
                {% if task.task_time %}({{ task.task_time.strftime('%H:%M') }}){% endif %}
            </li>
        {% endfor %}
        </ul>
    {% endif %}
</div>


<!-- TASK SECTIONS  -->
<h2>All Tasks ({{ (incomplete_tasks + completed_tasks)|length }} total)</h2>

{# show incomplete first then completed, using separate loops so UI and actions are clear #}

<h4 class="mt-4">🟢 Incomplete Tasks</h4>
{% if incomplete_tasks %}
  {% for task in incomplete_tasks %}
    <div class="card mb-2 border-start border-success border-3 shadow-sm">
      <div class="card-body d-flex justify-content-between align-items-center">
        
        <!-- Task info -->
        <div>
          <strong>{{ task.name }}</strong>
          {% if task.due_date %}
            <span class="badge bg-secondary">Due: {{ task.due_date.strftime('%Y-%m-%d') }}</span>
          {% endif %}
          {% if task.task_time %}
            <span class="badge bg-info">🕒 {{ task.task_time.strftime('%I:%M %p') }}</span>
          {% endif %}
          <span class="badge bg-primary">{{ task.category }}</span>
        </div>

        <!-- Action buttons -->
        <div class="d-flex gap-2">
          <form method="POST" action="{{ url_for('complete_task', task_id=task.id) }}" class="m-0">
            {{ form.csrf_token }}
            <button type="submit" class="btn btn-success btn-sm rounded-pill shadow-sm">
              ✅ Complete
            </button>
          </form>

          <a href="{{ url_for('edit_task', task_id=task.id) }}" 
             class="btn btn-warning btn-sm rounded-pill shadow-sm">
             ✏️ Edit
          </a>

          <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}" 
                onsubmit="return confirm('Delete?')" class="m-0">
            {{ form.csrf_token }}
            <button type="submit" class="btn btn-danger btn-sm rounded-pill shadow-sm">
              🗑️ Delete
            </button>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-warning">No incomplete tasks found!</div>
{% endif %}

<hr>

<h4 class="mt-4">⚪ Completed Tasks</h4>
{% if completed_tasks %}
  {% for task in completed_tasks %}
    <div class="card mb-2 bg-light shadow-sm">
      <div class="card-body d-flex justify-content-between align-items-center text-muted">
        
        <!-- Task info -->
        <div>
          <strong><s>{{ task.name }}</s></strong>
          {% if task.due_date %}
            <span class="badge bg-secondary">Due: {{ task.due_date.strftime('%Y-%m-%d') }}</span>
          {% endif %}
          {% if task.task_time %}
            <span class="badge bg-info">🕒 {{ task.task_time.strftime('%I:%M %p') }}</span>
          {% endif %}
          <span class="badge bg-primary">{{ task.category }}</span>
        </div>

        <!-- Action buttons -->
        <div class="d-flex gap-2">
          <a href="{{ url_for('edit_task', task_id=task.id) }}" 
             class="btn btn-warning btn-sm rounded-pill shadow-sm">
             ✏️ Edit
          </a>
          <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}" 
                onsubmit="return confirm('Delete?')" class="m-0">
            {{ form.csrf_token }}
            <button type="submit" class="btn btn-danger btn-sm rounded-pill shadow-sm">
              🗑️ Delete
            </button>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-secondary">No completed tasks yet</div>
{% endif %}

  <!-- Copyright -->
<body class="dark-mode">
  <div class="footer">
    &copy; 2025 Arham Malik. All rights reserved. | <a href="https://mail.google.com/mail/u/0/#inbox?compose=CllgCKCFTDJnNtRKbQmlxLmsBNLPgDcMbtVRzfLgbFPtfFHcMQNXpHJMWBmBSXTRNHqQHFGvkVV">Contact</a>
  </div>
</body>

<style>
/* Base footer style */
.footer {
  width: 100%;             /* stretch full width */
  display: block;          
  text-align: center;
  padding: 20px;
  font-size: 14px;
  color: #777;
  background: #f4f4f4;     /* light background */
  margin-top: 40px;
  border-top: 1px solid #ddd;
}

/* Footer links */
.footer a {
  color: #2980b9;
  text-decoration: none;
  font-weight: 500;
}

/* Dark mode footer (Bootstrap theme toggle) */
html[data-bs-theme="dark"] .footer {
  background: #1a1a1a;     /* dark background */
  color: #f1f1f1;          /* light text */
  border-top: 1px solid #444;
}

/* Dark mode footer links */
html[data-bs-theme="dark"] .footer a {
  color: #3498db;
}
</style>

  <!-- Theme toggle logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const html  = document.documentElement; // <html>
      const btn   = document.getElementById('themeToggle');
      const icon  = document.getElementById('themeIcon');

      // Helper to update icon based on theme
      const setIcon = theme => { icon.textContent = theme === 'dark' ? '🌙' : '☀️'; };

      // Load stored theme or default to light
      const saved = localStorage.getItem('theme') || 'light';
      html.setAttribute('data-bs-theme', saved);
      setIcon(saved);

      // Toggle theme on click
      btn.addEventListener('click', () => {
        const next = (html.getAttribute('data-bs-theme') === 'light') ? 'dark' : 'light';
        html.setAttribute('data-bs-theme', next);
        localStorage.setItem('theme', next);
        setIcon(next);
      });
    });
  </script>
</body>
</html>
