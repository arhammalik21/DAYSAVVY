<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

  <title>DaySavvy</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

  <!-- Bootstrap CSS and Google Font -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">

<!-- User Authentication -->
 <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0;">
  <div><strong></strong></div>
  <div>
    {% if current_user %}
      <span class="me-2">Hi, {{ current_user.username }}</span>
      <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger">Logout</a>
    {% else %}
      <a href="{{ url_for('login') }}" class="btn btn-sm btn-outline-primary me-2">Login</a>
      <a href="{{ url_for('register') }}" class="btn btn-sm btn-success">Register</a>
    {% endif %}
  </div>
</div>

  <style>
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      background: var(--bs-body-bg);
      color: var(--bs-body-color);
      margin: 0;
    }
    h1, h2 { font-family: 'Montserrat', Arial, sans-serif; }

    .container { max-width: 900px; margin: 0 auto; }

    /* Flash messages styling */
    .flash { padding: 8px; border-radius: 4px; margin-bottom: 10px; }
    .flash-success { background: #d4edda; color: #155724; }
    .flash-info    { background: #cce5ff; color: #004085; }
    .flash-warning { background: #fff3cd; color: #856404; }

    /* Cards spacing and completed task style */
    .card { margin-bottom: 12px; }
    .completed-task { text-decoration: line-through; color: gray; }

    /* Force dark mode background if theme is dark */
    :root[data-bs-theme='dark'] { --bs-body-bg: #121212; }

    /* Navbar cleanup */
    .navbar { background-color: transparent !important; border-bottom: 0 !important; }

    /* Theme toggle button visuals */
    #themeToggle:hover { filter: brightness(1.15); }
    #themeToggle, #themeToggle:focus, #themeToggle:hover, #themeToggle:active {
      border: none !important; box-shadow: none !important;
    }

    .logo-title-container {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 0 !important;
      margin: 20px 0 !important;
      padding: 10 !important;
    }

    .logo {
      width: 200px !important;
      height: 200px !important;
      margin: 0 -40px 0 0 !important;
      padding: 10 !important;
      display: block !important;
    }

    .text-section {
      display: flex !important;
      flex-direction: column !important;
      justify-content: center !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .title {
      font-size: 3.5rem !important;
      font-weight: bold !important;
      color: #4a90e2 !important;
      margin: 0 !important;
      padding: 0 !important;
      letter-spacing: 2px !important;
      line-height: 1 !important;
    }

    .tagline {
      font-size: 1.3rem !important;
      color: #8b5fbf !important;
      margin: 8px 0 0 0 !important;
      padding: 0 !important;
      font-weight: 500 !important;
    }

    /* Buttons and mic visuals kept */
    .btn-ei-mic {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        font-weight: bold;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-ei-mic:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4); background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
    .btn-ei-mic:active { transform: translateY(-1px); }
    .btn-ei-mic i { font-size: 20px; }
    .mic-text { font-size: 14px; letter-spacing: 0.5px; }

    .btn-ei-mic.listening {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
    }

    #stopBtn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 50px;
        font-weight: bold;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    #stopBtn:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        background: linear-gradient(135deg, #ee5a24 0%, #ff6b6b 100%);
    }
    #stopBtn i { font-size: 18px; }

  </style>
</head>

<body>

<!--LOGO WITH TITLE AND TAGLINE -->
<div class="logo-title-container">
  <img src="{{ url_for('static', filename='Logo.png') }}" alt="Logo" class="logo">
  <div class="text-section">
    <h1 class="title">DaySavvy</h1>
    <p class="tagline">The World‚Äôs First EI Assistant‚Ñ¢</p> 
  </div>
</div>

  <!-- Minimal navbar with theme toggle -->
  <nav class="navbar px-3 mb-2 bg-transparent">
    <div class="container-fluid d-flex align-items-center">
      <button id="themeToggle"
              class="p-0 border-0 bg-transparent ms-auto"
              title="Toggle dark mode" aria-label="Toggle dark mode"
              style="font-size:1.35rem; line-height:1;">
        <span id="themeIcon">‚òÄÔ∏è</span>
      </button>
    </div>
  </nav>

  <!-- Main content container -->
  <div class="container pb-4">

    <!-- Flash messages (feedback after actions) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, message in messages %}
            <div class="flash flash-{{category}}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Field validation (server-side) -->
    {% if form.task.errors %}
      <div class="flash flash-warning">
        {% for error in form.task.errors %}
          {{ error }}
        {% endfor %}
      </div>
    {% endif %}

    <!-- Search & Filter bar -->
    <div class="card mb-3">
      <div class="card-body">
        <form method="GET" action="{{ url_for('index') }}" class="d-flex align-items-center gap-2 flex-wrap">
          <input
            type="text"
            name="q"
            class="form-control flex-grow-1"
            placeholder="Search tasks‚Ä¶"
            value="{{ request.args.get('q','') }}"
            style="min-width:240px;"
          >
          <select name="status" class="form-select" style="width:180px;">
            <option value="" {% if request.args.get('status','') == '' %}selected{% endif %}>All</option>
            <option value="incomplete" {% if request.args.get('status')=='incomplete' %}selected{% endif %}>Incomplete</option>
            <option value="completed"  {% if request.args.get('status')=='completed'  %}selected{% endif %}>Completed</option>
            <option value="overdue"    {% if request.args.get('status')=='overdue'    %}selected{% endif %}>Overdue</option>
          </select>
          <button type="submit" class="btn btn-outline-secondary">Filter</button>
          <!-- Clear resets filters by navigating to / without params -->
          <a class="btn btn-link ms-1" href="{{ url_for('index') }}">Clear</a>
        </form>
      </div>
    </div>

    <!-- Add Task form -->
    <div class="card mb-4">
  <div class="card-header">Add Task</div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('index') }}" class="row g-2">
      {{ form.csrf_token }}
      <div class="col-12">
        {{ form.task(class="form-control", placeholder="Task or goal (e.g., Prepare for my midterm exam)") }}
      </div>
      <div class="col-md-3">
        {{ form.due_date(class="form-control", placeholder="YYYY-MM-DD") }}
      </div>
      <div class="col-md-2">
        <input type="time" name="task_time" id="task_time" class="form-control" />
      </div>
      <div class="col-md-3">
        {{ form.category(class="form-select") }}
      </div>
      <div class="col-md-2 d-grid">
        <button type="submit" class="btn btn-primary">Add</button>
      </div>
      <div class="col-md-2 d-grid">
        <button type="button" id="decomposeBtn" class="btn btn-outline-primary">Decompose</button>
      </div>
        </form>
      </div>
    </div>

<!-- EI voice command block -->
<div class="mb-3">
    <button id="voiceBtn" class="btn btn-ei-mic" onclick="startVoiceControl()" aria-label="Start voice">
        <i class="material-icons-outlined">mic</i>
        <span class="mic-text">EI Voice</span>
    </button>
    <button id="stopBtn" class="btn btn-danger ms-2" onclick="stopVoiceControl()" style="display: none;" aria-label="Stop voice">
        <i class="material-icons-outlined">stop</i>
        Stop
    </button>
    <div id="voiceStatus" class="mt-2 text-muted">üéôÔ∏è Click EI Voice to start</div>

<!-- EI Voice: language + gender controls -->
<div class="d-flex align-items-center gap-2 mb-2">
  <select id="voiceLangSelect" class="form-select" style="width:140px">
    <option value="hinglish" selected>Hinglish</option>
    <option value="en">English</option>
    <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
  </select>
  <select id="voiceGenderSelect" class="form-select" style="width:140px">
    <option value="female" selected>Female</option>
    <option value="male">Male</option>
  </select>
</div>


<script>
// Globals
let csrfToken, isListening = false, recognition = null;

// CSRF + prefs init
(async () => {
  try { csrfToken = (await fetch('/csrf-token').then(r=>r.json())).csrf_token; } catch {}
  try {
    const p = await fetch('/voice/prefs', {credentials:'same-origin'}).then(r=>r.json());
    const langSel = document.getElementById('voiceLangSelect');
    const genSel  = document.getElementById('voiceGenderSelect');
    if (langSel && p.lang) langSel.value = p.lang;
    if (genSel && p.gender) genSel.value = p.gender;
  } catch {}
})();

// Save prefs on change
document.getElementById('voiceLangSelect')?.addEventListener('change', async (e) => {
  await fetch('/voice/prefs', { method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken},
    credentials:'same-origin', body: JSON.stringify({ lang: e.target.value }) });
});
document.getElementById('voiceGenderSelect')?.addEventListener('change', async (e) => {
  await fetch('/voice/prefs', { method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken},
    credentials:'same-origin', body: JSON.stringify({ gender: e.target.value }) });
});

// Remove duplicate playTTS (keep only one). This one is fine.
async function playTTS(text) {
  const langSel = document.getElementById('voiceLangSelect');
  const genSel  = document.getElementById('voiceGenderSelect');
  const res = await fetch('/voice/tts', {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken},
    credentials:'same-origin',
    body: JSON.stringify({ text: text || "", lang: langSel?.value || 'hinglish', gender: genSel?.value || 'female' })
  });
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const audio = new Audio(url);
  try { await audio.play(); } catch {}
  await new Promise(r => { audio.onended = r; audio.onerror = r; });
  URL.revokeObjectURL(url);
}
// Ensure all replies use neural TTS
window.speakText = function(text, cb){ return playTTS(text).then(()=>{ try{cb&&cb();}catch{} }); };
// STT helpers
function langToBCP47(v){ return v==='hi' ? 'hi-IN' : (v==='en' ? 'en-US' : 'en-IN'); }
function createRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return null;
  const r = new SR();
  const langSel = document.getElementById('voiceLangSelect');
  r.lang = langToBCP47(langSel?.value || 'hinglish');
  r.continuous = false;
  r.interimResults = false;
  return r;
}

// Start/Stop + loop
async function startVoiceControl(){
  if (isListening) return;
  isListening = true;
  document.getElementById('voiceBtn')?.classList.add('listening');
  document.getElementById('stopBtn').style.display = 'inline-block';
  document.getElementById('voiceStatus').textContent = '‚è≥ Starting‚Ä¶';

  try {
    const welcome = await fetch('/voice/welcome').then(r=>r.json());
    await speakText(welcome.message);
    document.getElementById('voiceStatus').textContent = welcome.message || 'üé§ Listening‚Ä¶';
    if (welcome.continue_listening) listenOnce();
  } catch (e) {
    document.getElementById('voiceStatus').textContent = '‚ùå Could not start voice.';
    stopVoiceControl();
  }
}
function stopVoiceControl(){
  isListening = false;
  try { recognition && recognition.stop(); } catch {}
  document.getElementById('voiceBtn')?.classList.remove('listening');
  document.getElementById('stopBtn').style.display = 'none';
  document.getElementById('voiceStatus').textContent = 'üõë Voice stopped';
}
function listenOnce(){
  if (!isListening) return;
  recognition = createRecognition();
  if (!recognition){
    document.getElementById('voiceStatus').textContent='‚ùå Speech not supported. Use Chrome.';
    return stopVoiceControl();
  }
  recognition.onstart  = () => document.getElementById('voiceStatus').textContent = 'üé§ Listening‚Ä¶';
  recognition.onerror  = (e) => {
    document.getElementById('voiceStatus').textContent = '‚ùå ' + e.error;
    if (e.error==='no-speech' && isListening){ setTimeout(listenOnce, 400); }
    else { stopVoiceControl(); }
  };
  recognition.onresult = async (ev) => {
    const transcript = ev.results[0][0].transcript.trim();
    document.getElementById('voiceStatus').textContent = `‚è≥ ‚Äú${transcript}‚Äù`;
    try {
      // Try command endpoint first
      let r = await fetch('/voice/command', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken},
        credentials:'same-origin',
        body: JSON.stringify({ transcript })
      }).then(x=>x.json());

      // If not recognized as a command, fallback to generative chat
    if (
      r && r.message &&
      (
        r.message.toLowerCase().includes("didn‚Äôt catch that") ||
        r.message.toLowerCase().includes("samajh nahi aaya") ||
        r.message.toLowerCase().includes("phir bolo") ||
        r.message.toLowerCase().includes("say it again")
      )
    ) {
        // Fallback to generative AI
      r = await fetch('/voice/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken},
        credentials:'same-origin',
        body: JSON.stringify({ message: transcript })
      }).then(x=>x.json());
      r.message = r.reply;
    }

      await speakText(r.message || 'OK');
      document.getElementById('voiceStatus').textContent = r.message || '‚úì';
      if (r.reload_page) { location.reload(); return; }
      if (r.continue_listening && isListening) setTimeout(listenOnce, 300);
      else stopVoiceControl();
    } catch(e) {
      document.getElementById('voiceStatus').textContent = '‚ùå Error processing.';
      stopVoiceControl();
    }
  };
  recognition.start();
}
// Expose to buttons
window.startVoiceControl = startVoiceControl;
window.stopVoiceControl  = stopVoiceControl;
</script>

<script>
// Replace speakText with neural TTS playback
async function playTTS(text) {
  try {
    const langSel = document.getElementById('voiceLangSelect');
    const genSel  = document.getElementById('voiceGenderSelect');
    const body = {
      text: text || "",
      lang: (langSel?.value || 'hinglish'),
      gender: (genSel?.value || 'female')
    };
    const res = await fetch('/voice/tts', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
      credentials: 'same-origin',
      body: JSON.stringify(body)
    });
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    await audio.play().catch(()=>{ /* ignore autoplay errors */ });
    await new Promise(resolve => { audio.onended = resolve; audio.onerror = resolve; });
    URL.revokeObjectURL(url);
  } catch(e) {
    console.error('TTS error', e);
  }
}

// Use playTTS wherever you currently call speakText
// 1) At start
// fetch("/voice/welcome").then(...).then(data => {
//   return playTTS(data.message).then(() => { ...listenOnce()... });
// });

// 2) After you POST /voice/command, replace speakText(data.message, ...) with:
/// playTTS(data.message).then(() => { /* continue or stop */ });
</script>

<!-- Decompose Task Modal -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('decomposeBtn');
  if (!btn) return;

  btn.addEventListener('click', async () => {
    const goalEl = document.querySelector('input[name="task"]');
    const dueEl  = document.querySelector('input[name="due_date"]');
    const timeEl = document.getElementById('task_time');

    let goal = goalEl?.value?.trim();
    let due  = dueEl?.value || '';
    let time = timeEl?.value || '';

    if (!goal) { alert('Enter a goal in the Task field first.'); return; }

    if (!window.csrfToken) {
      window.csrfToken = await fetch('/csrf-token', {credentials:'same-origin'})
        .then(r=>r.json()).then(j=>j.csrf_token);
    }

    // Try to find an existing parent card with the same name to avoid duplicates
    let parentId = undefined;
    const goalLower = goal.toLowerCase();
    document.querySelectorAll('button[onclick*="decomposeGoalFromBtn"][data-id][data-name]').forEach(b => {
      if ((b.dataset.name || '').trim().toLowerCase() === goalLower) {
        parentId = parseInt(b.dataset.id, 10);
      }
    });

    if (!due) {
      const d = prompt('Final due date for the goal? (YYYY-MM-DD) Optional. Leave blank to spread across next days.');
      if (d !== null) due = d.trim();
    }
    if (!time) {
      const t = prompt('Default time for subtasks? (HH:MM) Optional. Leave blank to stagger times automatically.');
      if (t !== null) time = t.trim();
    }

    // Ask for missing inputs so users don‚Äôt get ‚Äúsame time‚Äù everywhere
    if (!due) {
      const d = prompt('Final due date for the goal? (YYYY-MM-DD) Optional. Leave blank to spread across next days.');
      if (d !== null) due = d.trim();
    }
    if (!time) {
      const t = prompt('Default time for subtasks? (HH:MM) Optional. Leave blank to stagger times automatically.');
      if (t !== null) time = t.trim();
    }

    if (!window.csrfToken) {
      window.csrfToken = await fetch('/csrf-token', {credentials:'same-origin'})
        .then(r=>r.json()).then(j=>j.csrf_token);
    }

    // Preview
    const preview = await fetch('/api/tasks/decompose', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': window.csrfToken},
      credentials: 'same-origin',
      body: JSON.stringify({ goal, due_date: due || undefined, task_time: time || undefined })
    }).then(r=>r.json());

    const list = (preview.subtasks || [])
      .map(s => `‚Ä¢ ${s.name}${s.suggested_due_date ? ` ‚Äî ${s.suggested_due_date}` : ''}`)
      .join('\n') || '(no suggestions)';
    if (!confirm(`Create these subtasks?\n\n${list}`)) return;

    // Create (also send parent_id)
    const created = await fetch('/api/tasks/decompose', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': window.csrfToken},
      credentials: 'same-origin',
      body: JSON.stringify({
        parent_id: parentId,
        goal,
        due_date: due || undefined,
        task_time: time || undefined,
        create: true
      })
    }).then(r=>r.json());

    if (created.created) location.reload();
    else alert('Could not create subtasks.');
  });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Add Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

<form method="post">
    {{ form.hidden_tag() }}
</form>

    <!-- Tasks header with hint about current filter state -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      {% if request.args.get('q') or request.args.get('status') %}
        <small class="text-muted">
          Showing filtered results
          {% if request.args.get('q') %} for "{{ request.args.get('q') }}" {% endif %}
          {% if request.args.get('status') %} ({{ request.args.get('status') }}) {% endif %}
        </small>
      {% else %}
      {% endif %}
    </div>

    <!-- Group tasks into incomplete and completed ON THE FILTERED LIST -->
{% set incomplete_tasks = tasks | selectattr('completed', 'equalto', False) | list %}
{% set completed_tasks  = tasks | selectattr('completed', 'equalto', True)  | list %}


<!-- START: Hierarchical Parent + Subtasks -->
<h5 class="mt-4 mb-2">Your Goals and Subtasks</h5>

<div class="accordion" id="goalsAccordion">
  {% set groups = [
      ('üü¢ Incomplete', parents_incomplete, false),
      ('‚ö™ Completed',  parents_completed,  true)
  ] %}
  {% for label, parents_group, is_done in groups %}
    <div class="mb-2 mt-3">
      <div class="d-flex align-items-center justify-content-between">
        <h6 class="mb-0">{{ label }} ({{ parents_group|length }})</h6>
      </div>
    </div>

    {% if parents_group %}
      {% for p in parents_group %}
        {% set sid = 'goal_' ~ p.id %}
        <div class="accordion-item shadow-sm mb-2">
          <h2 class="accordion-header" id="h_{{ sid }}">
            <button class="accordion-button {{ 'collapsed' if not loop.first }} {{ 'text-muted' if p.completed }}"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#c_{{ sid }}"
                    aria-expanded="{{ 'true' if loop.first else 'false' }}"
                    aria-controls="c_{{ sid }}">
              <div class="w-100 d-flex justify-content-between align-items-center">
                <div>
                  {% if p.completed %}
                    <s class="text-muted">{{ p.name }}</s>
                  {% else %}
                    <span class="fw-semibold">{{ p.name }}</span>
                  {% endif %}
                  {% if p.due_date %}<span class="badge bg-secondary ms-2">Due: {{ p.due_date.strftime('%Y-%m-%d') }}</span>{% endif %}
                  {% if p.task_time %}<span class="badge bg-info ms-1">üïí {{ p.task_time.strftime('%I:%M %p') }}</span>{% endif %}
                  <span class="badge bg-primary ms-1">{{ p.category }}</span>
                  <span class="badge bg-warning text-dark ms-1">{{ p.priority }}</span>
                </div>
                <div class="small text-muted">
                  {{ (children_map.get(p.id, [])|length) }} subtasks
                </div>
              </div>
            </button>
          </h2>

          <div id="c_{{ sid }}" class="accordion-collapse collapse {{ 'show' if loop.first }}" aria-labelledby="h_{{ sid }}" data-bs-parent="#goalsAccordion">
            <div class="accordion-body">

              {% set subs = children_map.get(p.id, []) %}

              <!-- Parent actions -->
<div class="d-flex gap-2 mb-2">
  {% if not p.completed %}
  <form method="POST" action="{{ url_for('complete_task', task_id=p.id) }}" class="m-0"
      onsubmit="return confirm('Mark this goal and all its subtasks as complete?');">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <button type="submit" class="btn btn-success btn-sm rounded-pill">‚úÖ Complete</button>
</form>

  <a href="{{ url_for('edit_task', task_id=p.id) }}" class="btn btn-warning btn-sm rounded-pill">‚úèÔ∏è Edit</a>

  <button
    type="button"
    class="btn btn-outline-primary btn-sm rounded-pill"
    data-id="{{ p.id }}"
    data-name="{{ p.name }}"
    data-due="{{ p.due_date.strftime('%Y-%m-%d') if p.due_date else '' }}"
    data-time="{{ p.task_time.strftime('%H:%M') if p.task_time else '' }}"
    onclick="decomposeGoalFromBtn(this)"
  >
    {{ 'üß© Break Down' if (subs|length) == 0 else '‚ôªÔ∏è Break Down Again' }}
  </button>
  {% endif %}

  <form method="POST" action="{{ url_for('delete_task', task_id=p.id) }}" class="m-0"
      onsubmit="return confirm('Delete this goal and ALL its subtasks? This cannot be undone.');">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <button type="submit" class="btn btn-danger btn-sm rounded-pill">üóëÔ∏è Delete</button>
</form>
</div>
<script>
async function decomposeGoalFromParent(id, name, due, time) {
  try {
    const csrf = window.csrfToken || await fetch('/csrf-token', {credentials:'same-origin'})
      .then(r=>r.json()).then(j=>j.csrf_token);

    // Preview
    const preview = await fetch('/api/tasks/decompose', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': csrf},
      credentials: 'same-origin',
      body: JSON.stringify({
        parent_id: id,                  // attach to existing parent
        goal: name,
        due_date: due || undefined,
        task_time: time || undefined
      })
    }).then(r=>r.json());
     const list = (preview.subtasks || [])
      .map(s => '‚Ä¢ ' + s.name + (s.suggested_due_date ? ' ‚Äî ' + s.suggested_due_date : ''))
      .join('\n') || '(no suggestions)';
    if (!confirm(`Create these subtasks under "${name}"?\n\n${list}`)) return;
    // Create
    const created = await fetch('/api/tasks/decompose', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': csrf},
      credentials: 'same-origin',
      body: JSON.stringify({
        parent_id: id,                  // attach to existing parent
        goal: name,
        due_date: due || undefined,
        task_time: time || undefined,
        create: true
      })
    }).then(r=>r.json());

    if (created.created) location.reload();
    else alert('Could not create subtasks.');
  } catch (e) {
    console.error(e);
    alert('Error decomposing this goal.');
  }
}
</script>

              <!-- Subtasks -->
              {% if subs %}
                <ul class="list-group">
                  {% for s in subs %}
                    <li class="list-group-item d-flex justify-content-between align-items-center {{ 'text-muted' if s.completed }}">
                      <div>
                        {% if s.completed %}<s>{{ s.name }}</s>{% else %}<strong>{{ s.name }}</strong>{% endif %}
                        {% if s.due_date %}<span class="badge bg-secondary ms-2">Due: {{ s.due_date.strftime('%Y-%m-%d') }}</span>{% endif %}
                        {% if s.task_time %}<span class="badge bg-info ms-1">üïí {{ s.task_time.strftime('%I:%M %p') }}</span>{% endif %}
                        <span class="badge bg-primary ms-1">{{ s.category }}</span>
                      </div>
                      <div class="d-flex gap-2">
                        {% if not s.completed %}
                        <form method="POST" action="{{ url_for('complete_task', task_id=s.id) }}" class="m-0">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <button type="submit" class="btn btn-success btn-sm rounded-pill">Done</button>
</form>
                        {% endif %}
                        <a href="{{ url_for('edit_task', task_id=s.id) }}" class="btn btn-warning btn-sm rounded-pill">Edit</a>
                        <form method="POST" action="{{ url_for('delete_task', task_id=s.id) }}" class="m-0" onsubmit="return confirm('Delete this subtask?')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                          <button type="submit" class="btn btn-danger btn-sm rounded-pill">Delete</button>
                        </form>
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-muted">No subtasks yet.</div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-light border">No {{ label|lower }} tasks.</div>
    {% endif %}
  {% endfor %}
</div>

  <script>
async function decomposeGoalFromParent(id, name, due, time) {
  try {
    const csrf = window.csrfToken || await fetch('/csrf-token', {credentials:'same-origin'}).then(r=>r.json()).then(j=>j.csrf_token);
    const preview = await fetch('/api/tasks/decompose', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': csrf},
      credentials: 'same-origin',
      body: JSON.stringify({ goal: name, due_date: due || undefined, task_time: time || undefined })
    }).then(r=>r.json());
    const list = (preview.subtasks || []).map(s => `‚Ä¢ ${s.name}${s.suggested_due_date?` ‚Äî ${s.suggested_due_date}`:''}`).join('\n') || '(no suggestions)';
    if (!confirm(`Create these subtasks under "${name}"?\n\n${list}`)) return;

    const created = await fetch('/api/tasks/decompose', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': csrf},
      credentials: 'same-origin',
      body: JSON.stringify({ goal: name, due_date: due || undefined, task_time: time || undefined, create: true })
    }).then(r=>r.json());
    if (created.created) location.reload();
    else alert('Could not create subtasks.');
  } catch (e) {
    console.error(e);
    alert('Error decomposing this goal.');
  }
}
</script>

<script>
// Make CSRF available globally too
if (window.csrfToken == null) {
  fetch('/csrf-token', {credentials: 'same-origin'})
    .then(r => r.json())
    .then(j => { window.csrfToken = j.csrf_token; });
}

// Bridge: reads data-* from the button
function decomposeGoalFromBtn(btn) {
  const id   = parseInt(btn.dataset.id, 10);
  const name = btn.dataset.name || '';
  const due  = btn.dataset.due  || undefined;
  const time = btn.dataset.time || undefined;
  decomposeGoalFromParent(id, name, due, time);
}

// Single global function: preview ‚Üí confirm ‚Üí create (attaches to existing parent)
async function decomposeGoalFromParent(id, name, due, time) {
  try {
    const csrf = window.csrfToken || await fetch('/csrf-token', {credentials:'same-origin'})
      .then(r=>r.json()).then(j=>j.csrf_token);

    // Preview
    const preview = await fetch('/api/tasks/decompose', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': csrf},
      credentials: 'same-origin',
      body: JSON.stringify({
        parent_id: id,         // attach to existing parent (prevents duplicate)
        goal: name,
        due_date: due || undefined,
        task_time: time || undefined
      })
    }).then(r=>r.json());

    const list = (preview.subtasks || [])
      .map(s => '‚Ä¢ ' + s.name + (s.suggested_due_date ? ' ‚Äî ' + s.suggested_due_date : ''))
      .join('\n') || '(no suggestions)';
    if (!confirm(`Create these subtasks under "${name}"?\n\n${list}`)) return;

    // Create
    const created = await fetch('/api/tasks/decompose', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': csrf},
      credentials: 'same-origin',
      body: JSON.stringify({
        parent_id: id,         // attach to existing parent (prevents duplicate)
        goal: name,
        due_date: due || undefined,
        task_time: time || undefined,
        create: true
      })
    }).then(r=>r.json());

    if (created.created) location.reload();
    else alert('Could not create subtasks.');
  } catch (e) {
    console.error(e);
    alert('Error decomposing this goal.');
  }
}
</script>

  <!-- Copyright -->
<div class="footer">
  &copy; 2025 Arham Malik. All rights reserved. |
  <a href="...">Contact</a>
</div>

<style>
.footer {
  width: 100%;            
  display: block;          
  text-align: center;
  padding: 20px;
  font-size: 14px;
  color: #777;
  background: #f4f4f4;     
  margin-top: 40px;
  border-top: 1px solid #ddd;
}

.footer a {
  color: #2980b9;
  text-decoration: none;
  font-weight: 500;
}

html[data-bs-theme="dark"] .footer {
  background: #1a1a1a;     
  color: #f1f1f1;          
  border-top: 1px solid #444;
}

html[data-bs-theme="dark"] .footer a {
  color: #3498db;
}
</style>

  <!-- Theme toggle logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const html  = document.documentElement; 
      const btn   = document.getElementById('themeToggle');
      const icon  = document.getElementById('themeIcon');

      // Helper to update icon based on theme
      const setIcon = theme => { icon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è'; };

      // Load stored theme or default to light
      const saved = localStorage.getItem('theme') || 'light';
      html.setAttribute('data-bs-theme', saved);
      setIcon(saved);

      // Toggle theme on click
      btn.addEventListener('click', () => {
        const next = (html.getAttribute('data-bs-theme') === 'light') ? 'dark' : 'light';
        html.setAttribute('data-bs-theme', next);
        localStorage.setItem('theme', next);
        setIcon(next);
      });
    });
  </script>
</body>
</html>
